#!/bin/sh

# $Id: make-doc-files,v 1.16 2001/03/09 19:01:39 cph Exp $
#
# Copyright (c) 2000-2001 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

. /scheme/v7/dist/release-prefix

TL_DIR="$(pwd)"
BUILD_DIR_REL="$(get_release_prefix)"
BUILD_DIR="${TL_DIR}/${BUILD_DIR_REL}"
SRC_FILE="${BUILD_DIR}-src.tar.gz"
STAMP_BUILD="${TL_DIR}/stamp-build"

if [ ! -f "${SRC_FILE}" ]; then
    echo "No source file: ${SRC_FILE}."
    exit 1
fi

MKINSTALLDIRS="/scheme/v7/src/mkinstalldirs"
INSTALL="install"
INSTALL_DATA="${INSTALL} -m 644"

if [ ! -f "${STAMP_BUILD}" ];then
    rm -rf "${BUILD_DIR}"

    tar xzf "${SRC_FILE}"

    cd "${BUILD_DIR}/doc"
    ./configure
    make
    cd "${TL_DIR}"

    touch "${STAMP_BUILD}"
fi


make_tarfile ()
{
    TARFILE="${BUILD_DIR}-${1}.tar.gz"
    rm -f "${TARFILE}"
    tar cvzf "${TARFILE}" "${BUILD_DIR_REL}/${1}"
    chmod a-w "${TARFILE}"
}

make_zipfile ()
{
    ZIPFILE="${BUILD_DIR}-${1}.zip"
    rm -f "${ZIPFILE}"
    zip -r "${ZIPFILE}" "${BUILD_DIR_REL}/${1}"
    chmod a-w "${ZIPFILE}"
}

for TYPE in html info pdf ps; do
    IMAGE_ROOT="doc-${TYPE}"
    IMAGE_DIR="${BUILD_DIR}/${IMAGE_ROOT}"
    rm -rf "${IMAGE_DIR}"
    mkdir "${IMAGE_DIR}"
    (cd "${BUILD_DIR}/doc"; make "install-${TYPE}" "${TYPE}dir=${IMAGE_DIR}")
    make_tarfile "${IMAGE_ROOT}"
    make_zipfile "${IMAGE_ROOT}"
    case "${TYPE}" in
    html | pdf)
	rm -rf "${IMAGE_ROOT}"
	mv -f "${IMAGE_DIR}" .
	;;
    esac
done

rm -rf "${STAMP_BUILD}" "${BUILD_DIR}"
