#!/bin/sh

prefix=`/scheme/v7/dist/release-prefix`
rm -rf ${prefix}
mkdir ${prefix}
source=/scheme/v7/src
destination="${prefix}/src"
mkdir ${destination}

for file in 6001 ChangeLog COPYING Makefile.std TAGS compiler cref edwin microcode rcs runtime sf sos win32
do
  cpx -E ${source}/${file} ${destination}
done

find ${destination} -type d -name CVS -print | xargs rm -rf
find ${destination} -type f -print | xargs chmod a-w
find ${destination} -type d -print | xargs chmod g-w

tarfile=${prefix}-src.tar.gz
zipfile=${prefix}-src.zip
ucfile=${prefix}-src-ucode-gnu-linux.tar.gz

rm -f ${tarfile}
rm -f ${zipfile}
rm -f ${ucfile}

tar cvzf ${tarfile} ${destination}
zip -rl ${zipfile} ${destination}

(cd ${destination}/microcode; unxutl/config i386-linux)
tar cvzf ${ucfile} ${destination}/microcode

chmod -w ${tarfile} ${zipfile} ${ucfile}

rm -rf ${prefix}
