#!/bin/sh

# $Id: make-src-files,v 1.17 2001/03/02 18:07:32 cph Exp $
#
# Copyright (c) 2000-2001 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

. /scheme/v7/dist/release-prefix

INSTALL="install"
INSTALL_DATA="${INSTALL} -m 644"
PREFIX=`get_release_prefix`
TAG=`get_release_tag`

rm -rf ${PREFIX}
mkdir ${PREFIX}

(
    cd /scheme/v7/src/runtime
    TAG_STATUS="`cvs status -v version.scm | fgrep ${TAG}`"
    if [ -z "${TAG_STATUS}" ]; then
	cvs rtag ${TAG} v7/doc v7/src etc/xscheme.el
    fi
)

(
    cd ${PREFIX}
    cvs -d /scheme/cvsroot export -r ${TAG} -d src v7/src
    (cd src; ./Setup.sh)
    cvs -d /scheme/cvsroot export -r ${TAG} -d doc v7/doc
    (cd doc; autoconf)
    cvs -d /scheme/cvsroot export -r ${TAG} etc/xscheme.el
)

find ${PREFIX} -type f -print | xargs chmod g-w
find ${PREFIX} -type d -print | xargs chmod g-w

${INSTALL_DATA} /scheme/v7/src/ChangeLog changelog.txt
${INSTALL_DATA} /scheme/v7/src/ChangeLog ${PREFIX}/src/.
${INSTALL_DATA} /scheme/v7/doc/ChangeLog ${PREFIX}/doc/.
${INSTALL_DATA} /scheme/v7/dist/Makefile ${PREFIX}/.

tarfile=${PREFIX}-src.tar.gz
zipfile=${PREFIX}-src.zip
ucfile=${PREFIX}-src-ucode.tar.gz

rm -f ${tarfile}
rm -f ${zipfile}
rm -f ${ucfile}

tar cvzf ${tarfile} ${PREFIX}
tar cvzf ${ucfile} ${PREFIX}/src/COPYING ${PREFIX}/src/microcode

rm -rf ${PREFIX}/src/lib
symlinks -rd ${PREFIX}
zip -rl ${zipfile} ${PREFIX}

chmod -w changelog.txt ${tarfile} ${zipfile} ${ucfile}

rm -rf ${PREFIX}
