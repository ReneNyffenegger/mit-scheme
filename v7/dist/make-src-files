#!/bin/sh

prefix=`/scheme/v7/dist/release-prefix`
rm -rf ${prefix}
mkdir ${prefix}
destination="${prefix}/src"

(
    cd ${prefix}
    cvs -d /scheme/cvsroot checkout -d src v7/src
    cd src
    etc/build-tree.sh
)

find ${destination} -type d -name CVS -print | xargs rm -rf
find ${destination} -type f -print | xargs chmod a-w
find ${destination} -type d -print | xargs chmod g-w

cp -p /scheme/v7/src/ChangeLog changelog.txt
cp -p /scheme/v7/src/ChangeLog ${destination}/.

tarfile=${prefix}-src.tar.gz
zipfile=${prefix}-src.zip
ucfile=${prefix}-src-ucode-gnu-linux.tar.gz

rm -f ${tarfile}
rm -f ${zipfile}
rm -f ${ucfile}

tar cvzf ${tarfile} ${destination}
zip -rl ${zipfile} ${destination}

(cd ${destination}/microcode; unxutl/config i386-linux)
tar cvzf ${ucfile} ${destination}/microcode

chmod -w changelog.txt ${tarfile} ${zipfile} ${ucfile}

rm -rf ${prefix}
