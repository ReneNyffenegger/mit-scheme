#!/bin/sh

# $Id: make-src-files,v 1.12 2000/12/05 21:59:20 cph Exp $
#
# Copyright (c) 2000 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

prefix=`/scheme/v7/dist/release-prefix`
rm -rf ${prefix}
mkdir ${prefix}
destination="${prefix}/src"

(
    cd ${prefix}
    cvs -d /scheme/cvsroot checkout -P -d src v7/src
    cd src
    etc/build-tree.sh
)

find ${destination} -type d -name CVS -print | xargs rm -rf
find ${destination} -type f -print | xargs chmod a-w
find ${destination} -type d -print | xargs chmod g-w

cp -p /scheme/v7/src/ChangeLog changelog.txt
cp -p /scheme/v7/src/ChangeLog ${destination}/.

tarfile=${prefix}-src.tar.gz
zipfile=${prefix}-src.zip
ucfile=${prefix}-src-ucode-gnu-linux.tar.gz

rm -f ${tarfile}
rm -f ${zipfile}
rm -f ${ucfile}

tar cvzf ${tarfile} ${destination}
zip -rl ${zipfile} ${destination}

(cd ${destination}/microcode; unxutl/config i386-linux)
tar cvzf ${ucfile} ${destination}/microcode

chmod -w changelog.txt ${tarfile} ${zipfile} ${ucfile}

rm -rf ${prefix}
