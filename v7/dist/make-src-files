#!/bin/sh

# $Id: make-src-files,v 1.15 2001/01/08 20:52:17 cph Exp $
#
# Copyright (c) 2000-2001 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

. /scheme/v7/dist/release-prefix

INSTALL="install"
INSTALL_DATA="${INSTALL} -m 644"
PREFIX=`get_release_prefix`
TAG=`get_release_tag`

rm -rf ${PREFIX}
mkdir ${PREFIX}
DESTINATION="${PREFIX}/src"

(
    cd /scheme/v7/src/runtime
    TAG_STATUS="`cvs status -v version.scm | fgrep ${TAG}`"
    if [ -z "${TAG_STATUS}" ]; then
	cvs rtag ${TAG} v7/doc v7/src
    fi
)

(
    cd ${PREFIX}
    cvs -d /scheme/cvsroot export -r ${TAG} -d src v7/src
    cd src
    ./Setup.sh
)

find ${DESTINATION} -type f -print | xargs chmod g-w
find ${DESTINATION} -type d -print | xargs chmod g-w

${INSTALL_DATA} /scheme/v7/src/ChangeLog changelog.txt
${INSTALL_DATA} /scheme/v7/src/ChangeLog ${DESTINATION}/.

tarfile=${PREFIX}-src.tar.gz
zipfile=${PREFIX}-src.zip
ucfile=${PREFIX}-src-ucode.tar.gz

rm -f ${tarfile}
rm -f ${zipfile}
rm -f ${ucfile}

tar cvzf ${tarfile} ${DESTINATION}
tar cvzf ${ucfile} ${DESTINATION}/microcode

rm -rf ${DESTINATION}/lib
symlinks -rd ${DESTINATION}
zip -rl ${zipfile} ${DESTINATION}

chmod -w changelog.txt ${tarfile} ${zipfile} ${ucfile}

rm -rf ${PREFIX}
