#!/bin/sh

# $Id: make-dist-files,v 1.17 2001/03/10 02:40:21 cph Exp $
#
# Copyright (c) 2000-2001 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

set -e

TYPE=$1
DESTINATION=$2

if [ "${TYPE}" = "" ]; then
  TYPE="std"
fi

case "${TYPE}" in
6001|all|std|scmutils)
  ;;
*)
  echo "Unknown distribution type: ${TYPE}"
  exit 1
  ;;
esac

. /scheme/v7/dist/release-prefix

TL_DIR="$(pwd)"
BUILD_DIR_REL="$(get_release_prefix)"
BUILD_DIR="${TL_DIR}/${BUILD_DIR_REL}"
SRC_FILE="${BUILD_DIR}-src.tar.gz"
STAMP_BUILD="${TL_DIR}/stamp-build"
STAMP_IMAGE="${TL_DIR}/stamp-image"

IMAGE_DIR="${BUILD_DIR}-image"
BINDIR="${IMAGE_DIR}/usr/local/bin"
AUXDIR="${IMAGE_DIR}/usr/local/lib/mit-scheme"

if [ ! -f "${SRC_FILE}" ]; then
    echo "No source file: ${SRC_FILE}."
    exit 1
fi

MKINSTALLDIRS="/scheme/v7/src/mkinstalldirs"
INSTALL="install"
INSTALL_DATA="${INSTALL} -m 644"

# It takes a lot of work to build the image.
# Don't throw it away needlessly.

if [ ! -f "${STAMP_BUILD}" ];then
    rm -rf "${BUILD_DIR}"

    tar xzf "${SRC_FILE}"

    cd "${BUILD_DIR}/src"
    ./configure --enable-static-libs=yes --enable-dynamic-crypto=no \
	--with-mcrypt=no
    make

    cd "${BUILD_DIR}/doc"
    ./configure
    make

    touch "${STAMP_BUILD}"
fi

if [ ! -f "${STAMP_IMAGE}" ]; then
    rm -rf ${IMAGE_DIR}

    cd "${BUILD_DIR}/src"
    make install DESTDIR="${IMAGE_DIR}"
    ${MKINSTALLDIRS} "${AUXDIR}/doc/."
    ${INSTALL_DATA} COPYING "${AUXDIR}/doc/."

    cd "${BUILD_DIR}/doc"
    make install-info-gz DESTDIR="${IMAGE_DIR}" \
	infodir=/usr/local/lib/mit-scheme/edwin/info
    make install-html DESTDIR="${IMAGE_DIR}"

    ${INSTALL_DATA} /usr/local/info/dir "${AUXDIR}/edwin/info/."
    ${INSTALL_DATA} /usr/local/info/r4rs.* "${AUXDIR}/edwin/info/."
    ${INSTALL_DATA} /usr/local/info/r5rs.* "${AUXDIR}/edwin/info/."

    ALL_BANDS="runtime.com compiler.com edwin.com all.com 6001.com"
    case ${TYPE} in
    std)
	for BAND in ${ALL_BANDS}; do
	    case "${BAND}" in
	    "runtime.com"|"all.com")
		;;
	    *)
		rm -f "${AUXDIR}/${BAND}"
		;;
	    esac
	done
	;;
    all)
	;;
    6001)
	for BAND in ${ALL_BANDS}; do
	    case "${BAND}" in
	    "6001.com")
		;;
	    *)
		rm -f "${AUXDIR}/${BAND}"
		;;
	    esac
	done
	;;
    scmutils)
	for BAND in ${ALL_BANDS}; do
	    rm -f "${AUXDIR}/${BAND}"
	done
	;;
    esac

    #
    # Scmutils
    #
    if [ ${TYPE} = scmutils ]; then
	MECH_SOURCE=/sw/scmutils
	MECH_DEST=${IMAGE_DIR}/usr/local/scmutils
	${MKINSTALLDIRS} ${MECH_DEST}

	for DIR in $(cd ${MECH_SOURCE};find src -type d -print); do
	    ${MKINSTALLDIRS} ${MECH_DEST}/${DIR}
	    for FILE in ${MECH_SOURCE}/${DIR}/*.scm \
			${MECH_SOURCE}/${DIR}/*.doc \
			${MECH_SOURCE}/${DIR}/*.c
	    do
		[ -f ${FILE} ] && ${INSTALL_DATA} ${FILE} ${MECH_DEST}/${DIR}/.
	    done
	done
	${INSTALL_DATA} ${MECH_SOURCE}/src/copyrigh ${MECH_DEST}/src/copyright
	${INSTALL_DATA} ${MECH_SOURCE}/src/general/binio/transcript \
	    ${MECH_DEST}/src/general/binio/.
	rm -rf ${MECH_DEST}/src/commentary
	rm -rf ${MECH_DEST}/src/poly/zuras

	for DIR in $(cd ${MECH_SOURCE};find linux -type d -print); do
	    ${MKINSTALLDIRS} ${MECH_DEST}/${DIR}
	    for FILE in ${MECH_SOURCE}/${DIR}/*.bci; do
		[ -f ${FILE} ] && ${INSTALL_DATA} ${FILE} ${MECH_DEST}/${DIR}/.
	    done
	done
	rm -rf ${MECH_DEST}/linux/commentary

	${INSTALL_DATA} ${MECH_SOURCE}/dist/edwin-mechanics.com \
	    ${MECH_DEST}/linux/.
	ln -s ../../scmutils/linux/edwin-mechanics.com ${AUXDIR}/.
	${INSTALL_DATA} ${MECH_SOURCE}/linux/c-utils/* \
	    ${MECH_DEST}/linux/c-utils/.

	${MKINSTALLDIRS} ${MECH_DEST}/manual
	${INSTALL_DATA} ${MECH_SOURCE}/manual/refman.txt ${MECH_DEST}/manual/.

	${INSTALL} ${MECH_SOURCE}/dist/mechanics ${BINDIR}/.
	${INSTALL} ${MECH_SOURCE}/dist/edwin ${BINDIR}/.
    fi

    #
    # Adjust permissions
    #
    find ${IMAGE_DIR} -type f -print | xargs chmod og-w
    find ${IMAGE_DIR} -type d -print | xargs chmod og-w

    touch "${STAMP_IMAGE}"
fi

make_tarfile ()
{
    TARFILE="${TL_DIR}/${1}.tar.gz"
    [ -e "${TARFILE}" ] && rm -f "${TARFILE}"
    (cd ${IMAGE_DIR}/usr/local; tar cvzf "${TARFILE}" *)
    chmod 444 "${TARFILE}"
}

if [ "${DESTINATION}" = "" ]; then
  PRE="$(get_release_prefix)-ix86"
  make_tarfile "${PRE}-gnu-linux"
  ${INSTALL} /scheme/v7/dist/freebsd-bin/* "${BINDIR}/."
  make_tarfile "${PRE}-freebsd"
else
  make_tarfile "${DESTINATION}"
fi

rm -rf "${STAMP_IMAGE}" "${IMAGE_DIR}"

make_doc_file ()
{
    DOCFILE="${BUILD_DIR}-${2}.${3}"
    rm -f "${DOCFILE}"
    (cd "${TL_DIR}"; ${1} "${DOCFILE}" "${BUILD_DIR_REL}/${2}")
    chmod a-w "${DOCFILE}"
}

for TYPE in html info pdf ps; do
    IMAGE_ROOT="doc-${TYPE}"
    IMAGE_DIR="${BUILD_DIR}/${IMAGE_ROOT}"
    rm -rf "${IMAGE_DIR}"
    mkdir "${IMAGE_DIR}"
    (cd "${BUILD_DIR}/doc"; make "install-${TYPE}" "${TYPE}dir=${IMAGE_DIR}")
    make_doc_file "tar cvzf" "${IMAGE_ROOT}" "tar.gz"
    make_doc_file "zip -r" "${IMAGE_ROOT}" "zip"
    case "${TYPE}" in
    html | pdf)
	rm -rf "${TL_DIR}/${IMAGE_ROOT}"
	mv -f "${IMAGE_DIR}" "${TL_DIR}/."
	;;
    esac
done

rm -rf "${STAMP_BUILD}" "${BUILD_DIR}"
