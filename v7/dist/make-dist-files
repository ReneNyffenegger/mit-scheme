#!/bin/sh

# $Id: make-dist-files,v 1.11 2001/01/08 20:52:12 cph Exp $
#
# Copyright (c) 2000-2001 Massachusetts Institute of Technology
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or (at
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

TYPE=$1
DESTINATION=$2

if [ "${TYPE}" = "" ]; then
  TYPE="std"
fi

case "${TYPE}" in
6001|all|std|scmutils)
  ;;
*)
  echo "Unknown distribution type: ${TYPE}"
  exit 1
  ;;
esac

. /scheme/v7/dist/release-prefix

BUILD_DIR="`pwd`/build-$$"
BINDIR=${BUILD_DIR}/usr/local/bin
AUXDIR=${BUILD_DIR}/usr/local/lib/mit-scheme

MKINSTALLDIRS="/scheme/v7/src/mkinstalldirs"
INSTALL="install"
INSTALL_DATA="${INSTALL} -m 644"

rm -rf ${BUILD_DIR}
(
    cd /scheme/v7/linux
    make install DESTDIR=${BUILD_DIR}
)
(
    cd /scheme/v7/doc
    make install-info-gz DESTDIR=${BUILD_DIR} \
	infodir=/usr/local/lib/mit-scheme/edwin/info
    make install-html DESTDIR=${BUILD_DIR}
)

${MKINSTALLDIRS} ${AUXDIR}
${INSTALL_DATA} /scheme/v7/src/etc/optiondb.scm ${AUXDIR}/.

${MKINSTALLDIRS} ${AUXDIR}/doc
${INSTALL_DATA} /scheme/v7/src/COPYING ${AUXDIR}/doc/.

${MKINSTALLDIRS} ${AUXDIR}/edwin/info
${INSTALL_DATA} /usr/local/info/dir ${AUXDIR}/edwin/info/.
${INSTALL_DATA} /usr/local/info/r4rs.* ${AUXDIR}/edwin/info/.
${INSTALL_DATA} /usr/local/info/r5rs.* ${AUXDIR}/edwin/info/.

BANDS="runtime.com compiler.com edwin.com all.com 6001.com"
case ${TYPE} in
std)
    rm -f ${AUXDIR}/6001.com
    ;;
6001)
    for BAND in ${BANDS}; do
	[ "${BAND}" = "6001.com" ] || rm -f ${AUXDIR}/${BAND}
    done
    ;;
all)
    for BAND in ${BANDS}; do
	[ "${BAND}" = "all.com" ] || rm -f ${AUXDIR}/${BAND}
    done
    ;;
scmutils)
    for BAND in ${BANDS}; do
	rm -f ${AUXDIR}/${BAND}
    done
    ;;
esac

#
# Scmutils
#
if [ ${TYPE} = scmutils ]; then
    MECH_SOURCE=/sw/scmutils
    MECH_DEST=${BUILD_DIR}/usr/local/scmutils
    ${MKINSTALLDIRS} ${MECH_DEST}

    for DIR in `cd ${MECH_SOURCE};find src -type d -print`; do
	${MKINSTALLDIRS} ${MECH_DEST}/${DIR}
	for FILE in ${MECH_SOURCE}/${DIR}/*.scm \
		    ${MECH_SOURCE}/${DIR}/*.doc \
		    ${MECH_SOURCE}/${DIR}/*.c
	do
	    [ -f ${FILE} ] && ${INSTALL_DATA} ${FILE} ${MECH_DEST}/${DIR}/.
	done
    done
    ${INSTALL_DATA} ${MECH_SOURCE}/src/copyrigh ${MECH_DEST}/src/copyright
    ${INSTALL_DATA} ${MECH_SOURCE}/src/general/binio/transcript ${MECH_DEST}/src/general/binio/.
    rm -rf ${MECH_DEST}/src/commentary
    rm -rf ${MECH_DEST}/src/poly/zuras

    for DIR in `cd ${MECH_SOURCE};find linux -type d -print`; do
	${MKINSTALLDIRS} ${MECH_DEST}/${DIR}
	for FILE in ${MECH_SOURCE}/${DIR}/*.bci; do
	    [ -f ${FILE} ] && ${INSTALL_DATA} ${FILE} ${MECH_DEST}/${DIR}/.
	done
    done
    rm -rf ${MECH_DEST}/linux/commentary

    ${INSTALL_DATA} ${MECH_SOURCE}/dist/edwin-mechanics.com ${MECH_DEST}/linux/.
    ln -s ../../scmutils/linux/edwin-mechanics.com ${AUXDIR}/.
    ${INSTALL_DATA} ${MECH_SOURCE}/linux/c-utils/* ${MECH_DEST}/linux/c-utils/.

    ${MKINSTALLDIRS} ${MECH_DEST}/manual
    ${INSTALL_DATA} ${MECH_SOURCE}/manual/refman.txt ${MECH_DEST}/manual/.

    ${INSTALL} ${MECH_SOURCE}/dist/mechanics ${BINDIR}/.
    ${INSTALL} ${MECH_SOURCE}/dist/edwin ${BINDIR}/.
fi

#
# Adjust permissions
#
find ${BUILD_DIR} -type f -print | xargs chmod og-w
find ${BUILD_DIR} -type d -print | xargs chmod og-w

make_tarfile ()
{
    tarfile=${1}.tar.gz
    rm -f ${tarfile}
    (cd ${BUILD_DIR}/usr/local; tar cvzf ../../../${tarfile} *)
    chmod 444 ${tarfile}
}

if [ "${DESTINATION}" = "" ]; then
  PRE="`get_release_prefix`-ix86"
  make_tarfile "${PRE}-gnu-linux"
  ${INSTALL} /scheme/v7/dist/freebsd-bin/* ${BINDIR}/.
  make_tarfile "${PRE}-freebsd"
else
  make_tarfile ${DESTINATION}
fi

rm -rf ${BUILD_DIR}
